<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QA Agent Console</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a2f;
      --line: #25304d;
      --text: #e8eefc;
      --muted: #9fb0d8;
      --ok: #16a34a;
      --warn: #f59e0b;
      --fail: #ef4444;
      --brand: #4f46e5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, #1b2850 0%, var(--bg) 45%);
      color: var(--text);
    }
    .wrap { max-width: 1280px; margin: 24px auto; padding: 0 16px; }
    .topbar {
      display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px;
      background: rgba(18,26,47,.9); border: 1px solid var(--line); border-radius: 14px; padding: 12px;
      position: sticky; top: 10px; backdrop-filter: blur(10px); z-index: 2;
    }
    input, select, textarea, button {
      background: #0f162c; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 10px; font-size: 14px;
    }
    button { cursor: pointer; }
    .btn { background: var(--brand); border-color: #6158ff; }
    .btn.secondary { background: #1d2848; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-top: 14px; }
    .card {
      background: rgba(18,26,47,.9); border: 1px solid var(--line); border-radius: 14px; padding: 14px;
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .kpis { display: grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: 10px; }
    .kpi { background: #0f162c; border: 1px solid var(--line); border-radius: 12px; padding: 10px; }
    .kpi .v { font-size: 20px; font-weight: 700; }
    .kpi .k { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .badge { padding: 4px 8px; border-radius: 999px; font-weight: 600; font-size: 12px; }
    .PASS { background: rgba(22,163,74,.15); color: #86efac; }
    .PASS_WITH_WARNINGS { background: rgba(245,158,11,.15); color: #fcd34d; }
    .FAIL { background: rgba(239,68,68,.15); color: #fca5a5; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #233053; padding: 8px; text-align: left; font-size: 13px; }
    th { color: var(--muted); font-weight: 600; }
    .tabs { display: flex; gap: 8px; margin-bottom: 10px; }
    .tab { padding: 8px 10px; border: 1px solid var(--line); border-radius: 9px; cursor: pointer; color: var(--muted); }
    .tab.active { color: var(--text); background: #182447; }
    .panel { display: none; }
    .panel.active { display: block; }
    pre { margin: 0; background: #0f162c; border: 1px solid var(--line); border-radius: 10px; padding: 10px; overflow: auto; }
    .muted { color: var(--muted); font-size: 12px; }
    .advisory-box { margin-top: 10px; border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: #0f162c; }
    .advisory-item { padding: 8px; border-radius: 8px; margin-bottom: 8px; }
    .advisory-item.warn { background: rgba(245,158,11,.12); border: 1px solid rgba(245,158,11,.35); }
    .advisory-item.info { background: rgba(79,70,229,.12); border: 1px solid rgba(79,70,229,.35); }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
      .topbar { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 6px 0">QA Agent Console</h2>
    <div class="row" style="margin-bottom:8px;gap:8px">
      <button id="modeSimpleBtn" class="btn secondary">초보자 모드</button>
      <button id="modeAdvancedBtn" class="btn secondary">고급 모드</button>
    </div>
    <div class="muted" style="margin-bottom:10px">빠른 사용 순서: ① URL 입력 → ② 분석 또는 자동생성 클릭 → ③ 결과 TSV 복사/리포트 확인</div>

    <div class="topbar">
      <input id="baseUrlInput" type="text" placeholder="테스트할 URL 입력 (예: https://example.com)" />
      <select id="llmProvider" class="advanced-only"><option value="ollama" selected>ollama (로컬)</option><option value="openai">openai</option></select>
      <input id="llmModel" class="advanced-only" type="text" placeholder="모델명" value="qwen2.5:0.5b" />
      <div class="row" style="justify-content:flex-end">
        <button id="setApiBaseBtn" class="btn secondary advanced-only">API 주소</button>
        <button id="testApiBtn" class="btn secondary advanced-only">연결 테스트</button>
        <button id="analyzeBtn" class="btn secondary">1) 사이트 분석</button>
        <button id="oneClickBtn" class="btn">빠른 실행(원클릭)</button>
      </div>
    </div>
    <div class="muted" id="apiBaseHint" style="margin-top:8px">API: same-origin (현재 도메인)</div>

    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">PM 의사결정 카드</h3>
          <span id="finalBadge" class="badge">-</span>
        </div>
        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><div id="kCoverage" class="v">-</div><div class="k">Coverage</div></div>
          <div class="kpi"><div id="kConfidence" class="v">-</div><div class="k">Confidence</div></div>
          <div class="kpi"><div id="kAuthGate" class="v">-</div><div class="k">Auth Gate Pages</div></div>
          <div class="kpi"><div id="kCritical" class="v">-</div><div class="k">Critical Pages</div></div>
          <div class="kpi"><div id="kPrecision" class="v">-</div><div class="k">Form Precision</div></div>
        </div>
        <p id="riskText" class="muted" style="margin-top:10px">리스크: -</p>
        <div id="advisoryBox" class="advisory-box" style="display:none"></div>
        <div class="row" style="margin-top:10px">
          <button id="openHtml" class="btn secondary">HTML 리포트 열기</button>
          <button id="openJson" class="btn secondary">JSON 열기</button>
          <button id="openFixCsv" class="btn secondary">Fix CSV 열기</button>
          <button id="openFixXlsx" class="btn secondary">Fix XLSX 열기</button>
          <button id="copyTsv" class="btn secondary">체크리스트 TSV 복사</button>
        </div>
      </section>

      <section class="card">
        <h3 style="margin-top:0">체크리스트 생성</h3>
        <input id="checkScreen" class="advanced-only" type="text" placeholder="화면명 또는 URL (예: 로그인 화면)" />
        <textarea id="checkContext" class="advanced-only" rows="3" placeholder="추가 컨텍스트 (선택)"></textarea>
        <details class="advanced-only" style="margin:8px 0">
          <summary style="cursor:pointer;color:#9fb0d8">고급 설정 (로그인 필요한 페이지)</summary>
          <div style="margin-top:8px">
            <input id="authLoginUrl" type="text" placeholder="로그인 URL (예: https://example.com/login)" />
            <div class="row" style="margin-top:8px">
              <input id="authUserId" type="text" placeholder="테스트 계정 ID / 이메일" style="flex:1;min-width:180px" />
              <input id="authPassword" type="password" placeholder="테스트 계정 비밀번호" style="flex:1;min-width:180px" />
            </div>
          </div>
        </details>
        <div class="row">
          <label class="advanced-only"><input id="checkAuth" type="checkbox" /> 비로그인 접근 제어 포함</label>
          <label class="advanced-only"><input id="autoByMenu" type="checkbox" /> 메뉴맵 기준 URL 사용</label>
          <label><input id="execExhaustive" type="checkbox" /> 전수검사(느리지만 상세)</label>
          <label class="advanced-only"><input id="allowRiskyActions" type="checkbox" /> 위험액션 허용</label>
          <button id="checkBtn" class="btn secondary advanced-only">단일 체크리스트 생성</button>
          <button id="autoCheckBtn" class="btn">전체 자동생성(사이트맵/메뉴맵)</button>
          <button id="execBtn" class="btn secondary">체크리스트 실행</button>
          <button id="finalizeBtn" class="btn secondary advanced-only">최종시트 생성</button>
        </div>
        <div class="row advanced-only" style="margin-top:6px">
          <input id="exhaustiveDepth" type="number" min="0" max="2" value="1" style="width:120px" placeholder="전수 깊이" />
          <input id="exhaustiveBudgetMs" type="number" min="1000" step="1000" value="20000" style="width:160px" placeholder="전수 예산(ms)" />
          <span class="muted">권장: 깊이 1, 예산 20000ms</span>
        </div>
        <div class="row advanced-only" style="margin-top:6px">
          <button id="loadTemplatesBtn" class="btn secondary">전이 템플릿 불러오기</button>
          <select id="transitionTemplate" style="min-width:240px"><option value="">템플릿 선택</option></select>
          <button id="runTransitionBtn" class="btn secondary">전이검증 실행</button>
          <button id="conditionMatrixBtn" class="btn secondary">조건매트릭스 미리보기</button>
        </div>
        <div id="autoProgress" class="muted" style="margin-top:8px">자동생성 상태: 대기</div>
        <div id="execSummary" class="muted" style="margin-top:6px">실행 상태: 대기</div>
        <div id="transitionSummary" class="muted" style="margin-top:6px">전이검증 상태: 대기</div>
        <pre id="checkOut" style="margin-top:8px; max-height:210px">(생성 후 TSV 복사)</pre>
      </section>
    </div>

    <section class="card" style="margin-top:14px">
      <div class="tabs">
        <div class="tab active" data-tab="sitemap">Site Map</div>
        <div class="tab" data-tab="menu">Menu Map</div>
        <div class="tab" data-tab="logs">Logs/Raw</div>
      </div>

      <div id="panel-sitemap" class="panel active">
        <table>
          <thead><tr><th>Depth</th><th>Role</th><th>Path</th><th>Priority</th><th>Status</th></tr></thead>
          <tbody id="sitemapRows"></tbody>
        </table>
      </div>

      <div id="panel-menu" class="panel">
        <table>
          <thead><tr><th>Scope</th><th>Zone</th><th>Name</th><th>Href</th><th>Count</th></tr></thead>
          <tbody id="menuRows"></tbody>
        </table>
      </div>

      <div id="panel-logs" class="panel">
        <pre id="rawOut">(대기 중)</pre>
      </div>
    </section>
  </div>

<script>
  let lastReportPath = '';
  let lastReportJson = '';
  let lastFixCsv = '';
  let lastFixXlsx = '';
  let lastChecklistTSV = '';
  let lastExecutedRows = [];
  let lastTemplates = [];

  function setUIMode(mode) {
    const m = mode === 'advanced' ? 'advanced' : 'simple';
    localStorage.setItem('QA_UI_MODE', m);
    document.querySelectorAll('.advanced-only').forEach(el => {
      el.style.display = (m === 'advanced') ? '' : 'none';
    });
    const s = document.getElementById('modeSimpleBtn');
    const a = document.getElementById('modeAdvancedBtn');
    if (s && a) {
      s.style.opacity = (m === 'simple') ? '1' : '0.7';
      a.style.opacity = (m === 'advanced') ? '1' : '0.7';
    }
  }

  function getApiBase() {
    const fromGlobal = (window.QA_API_BASE || '').trim();
    const fromStorage = (localStorage.getItem('QA_API_BASE') || '').trim();
    const fromQuery = (new URLSearchParams(location.search).get('apiBase') || '').trim();
    const base = fromQuery || fromGlobal || fromStorage || '';
    return base.replace(/\/$/, '');
  }

  function apiUrl(path) {
    const base = getApiBase();
    return base ? `${base}${path}` : path;
  }

  function refreshApiHint(statusText = '') {
    const base = getApiBase();
    const originText = base ? `API: ${base}` : 'API: same-origin (현재 도메인)';
    document.getElementById('apiBaseHint').textContent = statusText ? `${originText} | ${statusText}` : originText;
  }

  async function testApiConnection(silent = false) {
    if (!silent) setButtonBusy('testApiBtn', true, '테스트중...');
    try {
      let ok = false;
      let detail = '';

      // fastapi health
      try {
        const rh = await fetch(apiUrl('/health'));
        const jh = await rh.json();
        if (rh.ok && (jh.ok === true || jh.service)) {
          ok = true;
          detail = 'health ok';
        }
      } catch (_) {}

      // fallback: node root/html check
      if (!ok) {
        try {
          const rr = await fetch(apiUrl('/'));
          if (rr.ok) {
            ok = true;
            detail = 'root ok';
          }
        } catch (_) {}
      }

      if (ok) {
        refreshApiHint('연결됨 ✅');
        if (!silent) alert('API 연결 성공 (' + detail + ')');
      } else {
        refreshApiHint('연결 실패 ❌');
        if (!silent) alert('API 연결 실패: 주소 또는 CORS 설정 확인 필요');
      }
    } catch (e) {
      refreshApiHint('연결 실패 ❌');
      if (!silent) alert('API 연결 실패: ' + (e?.message || e));
    } finally {
      if (!silent) setButtonBusy('testApiBtn', false);
    }
  }

  const DEFAULT_MODEL = {
    ollama: 'qwen2.5:0.5b',
    openai: 'gpt-4o-mini',
  };

  function getLLMOptions() {
    return {
      llmProvider: document.getElementById('llmProvider').value,
      llmModel: (document.getElementById('llmModel').value || '').trim(),
    };
  }

  function getAuthOptions() {
    const loginUrl = (document.getElementById('authLoginUrl')?.value || '').trim();
    const userId = (document.getElementById('authUserId')?.value || '').trim();
    const password = (document.getElementById('authPassword')?.value || '').trim();
    return {
      auth: {
        loginUrl,
        userId,
        password,
      },
    };
  }

  function setBadge(status) {
    const b = document.getElementById('finalBadge');
    b.className = 'badge ' + (status || '');
    b.textContent = status || '-';
  }

  function setButtonBusy(id, busy, busyText = '처리중...') {
    const btn = document.getElementById(id);
    if (!btn) return;
    if (busy) {
      if (!btn.dataset.originalText) btn.dataset.originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = busyText;
    } else {
      btn.disabled = false;
      if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
    }
  }

  function updateKPIs(quality, finalStatus) {
    document.getElementById('kCoverage').textContent = quality?.metrics?.coverageScore ?? '-';
    document.getElementById('kConfidence').textContent = quality?.confidence ?? '-';
    document.getElementById('kAuthGate').textContent = quality?.metrics?.authGatePages ?? '-';
    document.getElementById('kCritical').textContent = quality?.metrics?.criticalPages ?? '-';
    document.getElementById('kPrecision').textContent = quality?.formPrecision?.precisionScore ?? '-';
    document.getElementById('riskText').textContent = '리스크: ' + ((quality?.risks || []).join(' | ') || '-');
    setBadge(finalStatus);
  }

  function renderAdvisories(advisories) {
    const box = document.getElementById('advisoryBox');
    const rows = Array.isArray(advisories) ? advisories : [];
    if (!rows.length) {
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }
    box.style.display = 'block';
    box.innerHTML = '<div style="font-weight:700; margin-bottom:8px;">접근/수집 안내</div>' + rows.map(a => {
      const level = String(a?.severity || 'INFO').toLowerCase();
      const cls = level === 'warn' ? 'warn' : 'info';
      const msg = a?.message || '';
      const action = a?.action || '';
      const need = a?.needsCredentials ? ' • 테스트 계정(ID/PW) 필요' : '';
      return `<div class="advisory-item ${cls}"><div><b>${a?.type || 'ADVISORY'}</b>${need}</div><div>${msg}</div><div class="muted" style="margin-top:4px">${action}</div></div>`;
    }).join('');
  }

  function fileUrl(path) {
    const clean = String(path || '').replace(/^\//, '');
    const base = getApiBase();
    return base ? `${base}/${clean}` : `/${clean}`;
  }

  async function loadReports(paths) {
    if (!paths?.sitemapPath || !paths?.menuPath) return null;
    const sitemap = await (await fetch(fileUrl(paths.sitemapPath))).json();
    const menu = await (await fetch(fileUrl(paths.menuPath))).json();
    const quality = paths.qualityPath ? await (await fetch(fileUrl(paths.qualityPath))).json() : null;

    const sbody = document.getElementById('sitemapRows');
    sbody.innerHTML = '';
    (sitemap.rows || []).slice(0, 40).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.depth}</td><td>${r.role}</td><td><code>${r.path}</code></td><td>${r.priorityTier} (${r.priorityScore})</td><td>${r.httpStatus||'-'}</td>`;
      sbody.appendChild(tr);
    });

    const mbody = document.getElementById('menuRows');
    mbody.innerHTML = '';
    (menu.rows || []).slice(0, 40).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.scope}</td><td>${r.zone}</td><td>${r.name}</td><td><code>${r.href}</code></td><td>${r.count}</td>`;
      mbody.appendChild(tr);
    });

    return { sitemap, menu, quality };
  }

  async function onAnalyze() {
    const baseUrl = document.getElementById('baseUrlInput').value.trim();
    if (!baseUrl) return alert('URL 입력');
    setButtonBusy('analyzeBtn', true, '분석중...');
    try {
      const body = { baseUrl, ...getLLMOptions(), ...getAuthOptions() };
      const j = await (await fetch(apiUrl('/api/analyze'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (j.ok) {
        const reports = await loadReports(j.reports);
        updateKPIs(reports?.quality, '-');
        renderAdvisories(j.advisories || []);
      }
    } finally {
      setButtonBusy('analyzeBtn', false);
    }
  }

  async function onOneClick() {
    const baseUrl = document.getElementById('baseUrlInput').value.trim();
    if (!baseUrl) return alert('URL 입력');
    setButtonBusy('oneClickBtn', true, '실행중...');
    try {
      const body = { baseUrl, ...getLLMOptions(), ...getAuthOptions() };
      const j = await (await fetch(apiUrl('/api/oneclick'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (j.ok) {
        lastReportPath = j.reportPath || '';
        lastReportJson = j.reportJson || '';
        lastFixCsv = j.fixSheet?.csv || '';
        lastFixXlsx = j.fixSheet?.xlsx || '';
        const reports = await loadReports(j.analysisReports);
        updateKPIs(reports?.quality, j.finalStatus);
        renderAdvisories(j.advisories || j.analysis?.advisories || []);
      }
    } finally {
      setButtonBusy('oneClickBtn', false);
    }
  }

  async function onAutoChecklist() {
    const baseUrl = document.getElementById('baseUrlInput').value.trim();
    if (!baseUrl) return alert('URL 입력');
    const raw = document.getElementById('rawOut');
    const progress = document.getElementById('autoProgress');

    try {
      setButtonBusy('autoCheckBtn', true, '자동생성중...');
      progress.textContent = '자동생성 상태: 1/3 사이트맵 분석 중...';
      raw.textContent = '자동 체크리스트 생성 중... (analyze → screenshot → checklist)';

      const analyzed = await (await fetch(apiUrl('/api/analyze'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ baseUrl, ...getLLMOptions(), ...getAuthOptions() })
      })).json();
      if (!analyzed.ok || !analyzed.analysisId) {
        raw.textContent = JSON.stringify(analyzed, null, 2);
        progress.textContent = '자동생성 상태: 실패 (analyze)';
        return alert('analyze 실패');
      }

      const source = document.getElementById('autoByMenu').checked ? 'menu' : 'sitemap';
      progress.textContent = `자동생성 상태: 2/3 ${source==='menu'?'메뉴맵':'사이트맵'} URL별 스크린샷 + 체크리스트 생성 중...`;
      const auto = await (await fetch(apiUrl('/api/checklist/auto'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ analysisId: analyzed.analysisId, includeAuth: true, source, ...getLLMOptions(), ...getAuthOptions() })
      })).json();

      raw.textContent = JSON.stringify(auto, null, 2);
      if (auto.ok) {
        document.getElementById('checkOut').textContent = auto.tsv || '';
        lastChecklistTSV = auto.tsv || '';
        const shots = (auto.pageResults || []).map(x => x?.screenshot?.screenshotPath).filter(Boolean);
        progress.textContent = `자동생성 상태: 3/3 완료 (페이지 ${auto.pagesAudited}, 스크린샷 성공 ${auto.screenshotOk ?? shots.length})`;
        alert(`자동 생성 완료: ${auto.pagesAudited}개 페이지\n스크린샷 성공 ${auto.screenshotOk ?? shots.length} / 실패 ${auto.screenshotFailed ?? Math.max(0, (auto.pagesAudited||0)-shots.length)}`);
      } else {
        progress.textContent = '자동생성 상태: 실패 (auto checklist)';
      }
    } catch (e) {
      progress.textContent = '자동생성 상태: 실패 (예외 발생)';
      raw.textContent = String(e?.message || e);
    } finally {
      setButtonBusy('autoCheckBtn', false);
    }
  }

  function parseTSV(tsv) {
    const text = String(tsv || '').trim();
    if (!text) return [];
    const lines = text.split(/\r?\n/).filter(Boolean);
    if (lines.length < 2) return [];
    const cols = lines[0].split('\t');
    return lines.slice(1).map(line => {
      const vals = line.split('\t');
      const row = {};
      cols.forEach((c, i) => row[c] = vals[i] || '');
      return row;
    });
  }

  async function onLoadTemplates() {
    try {
      setButtonBusy('loadTemplatesBtn', true, '불러오는중...');
      const j = await (await fetch(apiUrl('/api/qa/templates'))).json();
      const sel = document.getElementById('transitionTemplate');
      sel.innerHTML = '<option value="">템플릿 선택</option>';
      lastTemplates = (j.templates || []);
      lastTemplates.forEach(t => {
        const op = document.createElement('option');
        op.value = t.key;
        op.textContent = `[${t.category}] ${t.name}`;
        sel.appendChild(op);
      });
    } catch (e) {
      alert('템플릿 로드 실패: ' + (e?.message || e));
    } finally {
      setButtonBusy('loadTemplatesBtn', false);
    }
  }

  async function onRunTransition() {
    const baseUrl = document.getElementById('baseUrlInput').value.trim();
    const templateKey = document.getElementById('transitionTemplate').value;
    if (!baseUrl) return alert('URL 입력');
    if (!templateKey) return alert('템플릿 선택');
    const out = document.getElementById('transitionSummary');
    out.textContent = '전이검증 상태: 실행 중...';
    setButtonBusy('runTransitionBtn', true, '실행중...');
    try {
      const body = { templateKey, baseUrl, ...getAuthOptions() };
      const j = await (await fetch(apiUrl('/api/flow/transition-check'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (j.ok) {
        const s = j.summary || {};
        out.textContent = `전이검증 상태: PASS ${s.PASS||0} / FAIL ${s.FAIL||0} / BLOCKED ${s.BLOCKED||0}`;
      } else {
        out.textContent = '전이검증 상태: 실패';
      }
    } catch (e) {
      out.textContent = '전이검증 상태: 실패 (예외)';
    } finally {
      setButtonBusy('runTransitionBtn', false);
    }
  }

  async function onConditionMatrix() {
    const screen = document.getElementById('checkScreen').value.trim() || document.getElementById('baseUrlInput').value.trim();
    if (!screen) return alert('화면/URL 입력');
    setButtonBusy('conditionMatrixBtn', true, '생성중...');
    try {
      const body = { screen, context: (document.getElementById('checkContext').value || '').trim(), ...getLLMOptions() };
      const j = await (await fetch(apiUrl('/api/condition-matrix'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (!j.ok) alert('조건매트릭스 생성 실패');
    } finally {
      setButtonBusy('conditionMatrixBtn', false);
    }
  }

  async function onFinalizeReport() {
    const rows = lastExecutedRows?.length ? lastExecutedRows : parseTSV(lastChecklistTSV || document.getElementById('checkOut').textContent || '');
    if (!rows.length) return alert('먼저 체크리스트 실행 또는 생성 결과가 필요합니다.');
    setButtonBusy('finalizeBtn', true, '생성중...');
    try {
      const body = { projectName: 'QA 테스트시트', items: rows };
      const j = await (await fetch(apiUrl('/api/report/finalize'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (j.ok) {
        lastFixCsv = j.finalSheet?.csv || lastFixCsv;
        lastFixXlsx = j.finalSheet?.xlsx || lastFixXlsx;
        alert('최종시트 생성 완료');
      }
    } finally {
      setButtonBusy('finalizeBtn', false);
    }
  }

  async function onExecuteChecklist() {
    const rows = parseTSV(lastChecklistTSV || document.getElementById('checkOut').textContent || '');
    if (!rows.length) return alert('먼저 체크리스트를 생성하세요.');
    setButtonBusy('execBtn', true, '실행중...');
    const summaryEl = document.getElementById('execSummary');
    summaryEl.textContent = '실행 상태: 체크리스트 실행 중...';
    try {
      const exhaustive = !!document.getElementById('execExhaustive').checked;
      const exhaustiveDepth = Math.max(0, parseInt(document.getElementById('exhaustiveDepth')?.value || '1', 10) || 1);
      const exhaustiveBudgetMs = Math.max(1000, parseInt(document.getElementById('exhaustiveBudgetMs')?.value || '20000', 10) || 20000);
      const allowRiskyActions = !!document.getElementById('allowRiskyActions')?.checked;
      const body = { projectName: 'QA 실행 결과', rows, exhaustive, exhaustiveClicks: 12, exhaustiveInputs: 12, exhaustiveDepth, exhaustiveBudgetMs, allowRiskyActions, ...getAuthOptions() };
      const j = await (await fetch(apiUrl('/api/checklist/execute'), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      })).json();
      document.getElementById('rawOut').textContent = JSON.stringify(j, null, 2);
      if (j.ok) {
        lastExecutedRows = j.rows || [];
        const s = j.summary || {};
        const c = j.coverage || {};
        const un = c.untestedEstimate || {};
        const ex = (c.exhaustive || {}).probeSummary || {};
        summaryEl.textContent = `실행 상태: PASS ${s.PASS||0} / FAIL ${s.FAIL||0} / BLOCKED ${s.BLOCKED||0} | 미실행추정 버튼 ${un.buttons||0}, 링크 ${un.links||0}, 입력 ${un.inputs||0} | 전수추가 버튼 ${ex.buttons||0}, 입력 ${ex.inputs||0} | depth ${exhaustiveDepth}, budget ${exhaustiveBudgetMs}ms, risky ${allowRiskyActions?'on':'off'}`;
      } else {
        summaryEl.textContent = '실행 상태: 실패';
      }
    } catch (e) {
      summaryEl.textContent = '실행 상태: 실패 (예외)';
    } finally {
      setButtonBusy('execBtn', false);
    }
  }

  async function onChecklist() {
    const screen = document.getElementById('checkScreen').value.trim();
    if (!screen) return alert('화면명 입력');
    setButtonBusy('checkBtn', true, '생성중...');
    try {
      const context = document.getElementById('checkContext').value.trim();
      const includeAuth = !!document.getElementById('checkAuth').checked;
      const j = await (await fetch(apiUrl('/api/checklist'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ screen, context, includeAuth, ...getLLMOptions(), ...getAuthOptions() })
      })).json();
      document.getElementById('checkOut').textContent = j.ok ? j.tsv : JSON.stringify(j, null, 2);
      lastChecklistTSV = j.tsv || '';
    } finally {
      setButtonBusy('checkBtn', false);
    }
  }

  document.getElementById('analyzeBtn').addEventListener('click', onAnalyze);
  document.getElementById('oneClickBtn').addEventListener('click', onOneClick);
  document.getElementById('checkBtn').addEventListener('click', onChecklist);
  document.getElementById('autoCheckBtn').addEventListener('click', onAutoChecklist);
  document.getElementById('execBtn').addEventListener('click', onExecuteChecklist);
  document.getElementById('finalizeBtn').addEventListener('click', onFinalizeReport);
  document.getElementById('loadTemplatesBtn').addEventListener('click', onLoadTemplates);
  document.getElementById('runTransitionBtn').addEventListener('click', onRunTransition);
  document.getElementById('conditionMatrixBtn').addEventListener('click', onConditionMatrix);
  document.getElementById('testApiBtn').addEventListener('click', testApiConnection);
  document.getElementById('modeSimpleBtn').addEventListener('click', () => setUIMode('simple'));
  document.getElementById('modeAdvancedBtn').addEventListener('click', () => setUIMode('advanced'));

  document.getElementById('setApiBaseBtn').addEventListener('click', () => {
    const current = getApiBase();
    const next = prompt('백엔드 API 주소를 입력하세요.\n예) https://qa-mvp-api.onrender.com\n비우면 same-origin', current);
    if (next === null) return;
    const clean = String(next || '').trim().replace(/\/$/, '');
    if (clean) localStorage.setItem('QA_API_BASE', clean);
    else localStorage.removeItem('QA_API_BASE');
    refreshApiHint();
  });

  document.getElementById('llmProvider').addEventListener('change', (e) => {
    const provider = e.target.value;
    const modelInput = document.getElementById('llmModel');
    if (!modelInput.value.trim() || modelInput.value === DEFAULT_MODEL.openai || modelInput.value === DEFAULT_MODEL.ollama) {
      modelInput.value = DEFAULT_MODEL[provider] || '';
    }
    modelInput.placeholder = DEFAULT_MODEL[provider] || 'model';
  });

  document.getElementById('openHtml').addEventListener('click', () => {
    if (!lastReportPath) return alert('먼저 실행하세요.');
    window.open(fileUrl(lastReportPath), '_blank');
  });
  document.getElementById('openJson').addEventListener('click', () => {
    if (!lastReportJson) return alert('먼저 실행하세요.');
    window.open(fileUrl(lastReportJson), '_blank');
  });
  document.getElementById('openFixCsv').addEventListener('click', () => {
    if (!lastFixCsv) return alert('Fix CSV가 없습니다. (oneclick/run 후 생성)');
    window.open(fileUrl(lastFixCsv), '_blank');
  });
  document.getElementById('openFixXlsx').addEventListener('click', () => {
    if (!lastFixXlsx) return alert('Fix XLSX가 없습니다. (oneclick/run 후 생성)');
    window.open(fileUrl(lastFixXlsx), '_blank');
  });
  document.getElementById('copyTsv').addEventListener('click', async () => {
    if (!lastChecklistTSV) return alert('먼저 체크리스트 생성');
    await navigator.clipboard.writeText(lastChecklistTSV);
    alert('복사 완료');
  });

  // initialize model placeholder/value from selected provider
  {
    const mode = (localStorage.getItem('QA_UI_MODE') || 'simple').trim();
    setUIMode(mode);
    const provider = document.getElementById('llmProvider').value;
    const modelInput = document.getElementById('llmModel');
    modelInput.placeholder = DEFAULT_MODEL[provider] || 'model';
    if (!modelInput.value.trim()) modelInput.value = DEFAULT_MODEL[provider] || '';
    refreshApiHint();
    setTimeout(() => { testApiConnection(true).catch(() => {}); }, 200);
    setTimeout(() => { onLoadTemplates().catch(() => {}); }, 300);
  }

  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('panel-' + t.dataset.tab).classList.add('active');
    });
  });
</script>
</body>
</html>
